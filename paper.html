<html>

<head>
  <title>foo</title>

  <style>
    body {
      background: #eee;
/*      width: 1400px;*/
    }
    
    * {
      padding: 0;
      margin: 0;
    }

    button#pause {
      position: absolute;
      left: 640px;
      top: 20px;
      z-index: 2;
      font-size: 16px;
    }
    
    #fps {
      font-size: 9px;
      position: absolute;
      z-index: 4;
      left: 0;
      bottom: 0;
    }
    
    canvas#canvas {
			margin: 8px;
      position: relative;
      z-index: 1;
	  	background: #eee;
      border: 0;
    }
    
    #editor {
      position: absolute;
      width: 500px;
      height: 400px;
			left: 640px;
      top: 0;
    }
    
    
    /* snorkle.css */
		
		
		div#results .raw { display: none; }
		div#results .value {
			width: 100px;
			text-align: right;
			display: inline-block;
		}
		
    ul#vars { 
      z-index: 3;
/*      float: right;*/
			position: absolute;
			left: 690px;
			font-family: Helvetica;
			top: 420px;
      background-color: white;
      width: 480px;
/*      margin: 4px 12px;*/
      list-style: none;
      font-size: 18px;
      font-weight: bold;
      color: #aaa;
    }
    ul#vars h1 {
      font-size: 12px;
      background-color: #333;
      padding: 2px 0 2px 8px;
      color: white;
    }
    ul#vars .viz {
      display: inline-block;
      width: 120px;
			vertical-align: top;
      margin-left: 70px;

    }
    ul#vars .viz canvas {
			position: absolute;
			right: 4px;
		}
    ul#vars .raw {
      color: #ddd;
    }
    ul#vars input {
      font-family: Monaco;
      position: absolute;
      left: 4px;
      right: 4px;
      font-size: 10px;
      bottom: 2px;
			border: 0;
/*			border-bottom: 1px solid #aaa;*/
			background: #fff;
			color: #222;
			padding: 2px 4px;
		}
    ul#vars h2 {
      position: absolute;
      left: 6px;
      top: 6px;
      font-size: 16px;
    }
    ul#vars li {
      background-color: white;
      border-bottom: 2px solid #eee;
      position: relative;
      margin: 0 0 0px 0;
    }
    ul#vars li.result {
      padding-bottom: 24px;
    }
    ul#vars span {
			font-size: 14px;
			font-weight: normal;
/*      font-family: "Courier New";*/
    }
  </style>
    
    
  <script type="text/javascript" src="js/lib/canvas/paper.js"></script> 

  <script type="text/javascript" src="js/lib/jquery-1.7.min.js"></script>
  <script type="text/javascript" src="js/lib/underscore.js"></script>
  <script type="text/javascript" src="js/lib/backbone.js"></script>
  <script type="text/javascript" src="js/lib/json2.js"></script>
  <script type="text/javascript" src="js/lib/dataviz/jquery.sparkline.js"></script>

  <script type="text/javascript" src="js/snorkle.js"></script>


  <!-- script type="text/javascript" src="js/lib/meh/MochiKit/MochiKit.js"></script> 
  <script type="text/javascript" src="js/lib/canvas/SVGKit.js"></script> 
  <script type="text/javascript" src="js/lib/canvas/SVGCanvas.js"></script --> 
  <!-- // <script type="text/javascript" src="js/lib/DAT.GUI.js"></script> -->
</head>

<body>
  <span id="fps"></span>
  <button id="pause">||</button>
    
  <canvas id="canvas" keepalive="true" width='620' height='870'></canvas>

  <div id="meh"></div>
  
<div id="editor">
</div>
  
	<script type="text/javascript" src="http://localhost:8339/socket.io/socket.io.js"></script>
  
  <script src="js/lib/ace/ace.js" type="text/javascript" charset="utf-8"></script>
  <script src="js/lib/ace/theme-twilight.js" type="text/javascript" charset="utf-8"></script>  
  <script src="js/lib/ace/mode-javascript.js" type="text/javascript" charset="utf-8"></script>

  <script type='text/javascript'>
  var focused = true;
  window.onblur  = function() { focused = false; };
  window.onfocus = function() { focused = true; };

  var J = new Snorkle;

  J.addInputArray( 'mouse', { initial: 0.1 } );

  var acc_options = { min: -10, max: 10,  initial: 0 };

  // J.addInput( 'accX', acc_options );
  // J.addInput( 'accY', acc_options );
  // J.addInput( 'accZ', acc_options );
  // J.addInput( 'compass', { min: 0, max: 360, initial: 180 } );
  
  J.addOutput( 'scale' );
  J.addOutput( 'gap' );
	J.addOutput( 'A' );
  J.addOutput( 'B' );
  J.addOutput( 'C' );
  J.addOutput( 'D' );
  J.addOutput( 'E' );
	J.addOutput( 'F' );
	J.addOutput( 'rand' );
  J.addOutput( 'wave' );
	
  var acc = {};
  
  // if (window.DeviceMotionEvent != undefined) {
  // 	  window.ondevicemotion = function(event) {
  //     acc.x = event.accelerationIncludingGravity.x;
  //     acc.y = event.accelerationIncludingGravity.y;
  //     acc.z = event.accelerationIncludingGravity.z;
  //   }
  //   
  //   window.addEventListener('deviceorientation', function(e) {
  //     acc.compass = e.webkitCompassHeading;
  //   });
    // setInterval( function() {  	
    //   	  J.get('accX').value( acc.x );
    //   	  J.get('accY').value( acc.y );		
    //   J.get('accZ').value( acc.z );
    //   
    //   // J.get('compass').value( acc.compass );
    // }, 100);
  // }
  
  $(window).bind( 'mousemove', function(e) {
    J.get('mouse').value([ e.clientX, e.clientY ]);
  });
	
	
	if (typeof io != "undefined") {
	  var socket = io.connect('http://localhost:8339');
	  socket.on('face', function (data) {
	    var id = data.shift(),
	        t  = data.shift(),
	        face = {};

			if (data.length) {
		    _(data).each(function(v) {
		      face[ v[0].replace(/\//g, '_') ] = v.splice(1);
		    });
			} else {
				face[id.replace(/\//g, '_')] = t;
			}
      
	    J.pumpInput( face );
    
	    // socket.emit('my other event', { my: 'data' });
	  });
	}
	
  
  
  // https://github.com/paperjs/paper.js/issues/48
  // SVGCanvas.prototype.transform = SVGCanvas.prototype.translate;
  // SVGCanvas.prototype.fillText = SVGCanvas.prototype.text;
  // 
  // paper.View.prototype.toSVG = function() {
  //   var svgContext = new SVGCanvas(this.canvas.width, this.canvas.height);
  // 
  //   var oldCtx = this._context;
  // 
  //   this._context = svgContext;  
  //   this.draw(false);
  // 
  //   this._context = oldCtx;
  // 
  //   // Optional serialization of the SVG DOM nodes
  //   var serializer = new XMLSerializer();
  //   return serializer.serializeToString(svgContext.svg.htmlElement);
  // };


  // called if we're in simple mode
  var default_f = function(ev, n) {
		with(v.inputs) {
	    var i = ev.count;
	    var b = n % 2,
	        c = Math.floor(n / 2) * A,
	        d = Math.sin(n * 10000) * B,
	        e = 2; // Math.sin(i / 50);

	    v.path.strokeWidth = C;
	    v.path.strokeColor = '#ff0';

	    return {   x: 0 + b * v.width,
	               y: 3 + d + c
	    };
		}
  }
  
  var simple_mode = false,
      mine = default_f,
      editor;


  if (! simple_mode) {
    var on_code_change = function(ev) {
      var f_text = editor.getSession().getValue();
      try {
				mine = new Function('ev', 'n', 'with(v.inputs) { ' + f_text + ' } ');
      } catch (e) {
      }
      localStorage.setItem('mine111', f_text);
    };
  
    window.onload = function() {
      var saved_f = localStorage.getItem('mine111') || 'return 1';
      editor = ace.edit("editor");
      editor.setTheme("ace/theme/twilight");
      var JavaScriptMode = require("ace/mode/javascript").Mode;
      var session = editor.getSession();
      session.setValue( saved_f );
      on_code_change(); // initial setup
      session.setMode( new JavaScriptMode() );
      session.on('change', on_code_change);
    };
  }
  
  
  function toggle_pause () {
    v.pause = ! v.pause;
    $('#pause').text( v.pause ? '>' : '||' );
  }
  
  $('#pause').bind('touchstart', toggle_pause);
  $('#pause').bind('mousedown', toggle_pause);
  // $('body').bind('mousedown', toggle_pause);
  
  var $fps = $('#fps');
	
	window.previous = {};
	

  var breton_and_on = function() {
		paper.install(window);
    var canvas = document.getElementById('canvas');
    paper.setup(canvas); // Create an empty project and a view for the canvas
	
    v = {
			inputs: J.reals,
      pause: false,
      points: 800,
      smooth: false,
      mousePos: view.center / 2
    };
	
    v.path = new Path();
		v.path.strokeWidth = 0;
    v.path.closed = false;

    v.initializePath = function (points) {      
      v.center = view.center;
      v.width  = view.size.width;
      v.height = view.size.height / 2;
			
      v.path.segments = [];
      for (var i = 0; i < points; i++) {
        var point = new Point(v.width / points * i, view.center.y);
        v.path.add(point);
      }
      v.path.fullySelected = false;
    }

    v.initializePath(v.points);
		
    var onFrame = function(event) { // replace with your own
      J.updateReals();
			
      var no_op = _.isEqual( previous, v.inputs ); // && function has not changed

      if (no_op) return;

			previous = _.clone( v.inputs );

      if (v.pause || ! focused) return;
      $fps.text( 1 / event.delta);
      
      // v.pathHeight += (view.center.y - v.mousePos.y - v.pathHeight) / 10;
      
      J.recalculate();
      
      for (var i = 0; i < v.points; i++) {
        var pos = mine.call(v, event, i); // call with this set to p
        v.path.segments[i].point.y = pos.y;
        v.path.segments[i].point.x = pos.x;
      }
    
      if (v.smooth) { v.path.smooth(); }
    }
		
    view.onFrame = onFrame;
	};
	
	$(breton_and_on);
	
  </script>
</body>

</html>

<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <title>Accelerometer Javascript Test</title>
    <meta name="viewport" content="width=device-width,user-scalable=no"/>
    <style>
      body {
/*        height: 400px;*/
/*        overflow: hidden;*/
      	font-family: helvetica, arial, sans serif;
      	margin: 0;
      	background-color: #ddd;
      }
      div {
        margin: 4px;
      }

      * {
        margin: 0;
        padding: 0;
      }
      #sphere {
      	position: absolute;	
      	width: 5px;
      	height: 5px;
      	border-radius: 5px;
      	-webkit-radius: 5px;
      	background-color: blue;
      }
      
      h1 {
        font-size: 12px;
        background-color: #333;
        padding: 2px 0 2px 8px;
        color: white;
      }
      .viz {
        display: inline-block;
        width: 120px;
        margin-left: 100px;
      }
      .raw {
        color: #ddd;
      }
      
      input {
        font-family: Courier;
        position: absolute;
        left: 4px;
        right: 4px;
        font-size: 14px;
        bottom: 4px;
      }
      
      ul#vars { 
        background-color: white;
/*        width: 400px;*/
        margin: 4px 12px;
        list-style: none;
        font-size: 18px;
        font-weight: bold;
        color: #aaa;
      }
      h2 {
        position: absolute;
        left: 12px;
        top: 2px;
        font-size: 16px;
      }
      li {
        border-bottom: 1px solid #eee;
        position: relative;
        margin: 0 0 0px 0;
      }
      li.result {
        padding-bottom: 24px;
      }
      span {
        font-family: "Courier New";
      }
    </style>
    
    
    <script type="text/javascript" src="js/lib/jquery-1.7.min.js"></script>
    <script type="text/javascript" src="js/lib/underscore.js"></script>
    <script type="text/javascript" src="js/lib/backbone.js"></script>
    <script type="text/javascript" src="js/lib/json2.js"></script>
    <script type="text/javascript" src="js/lib/dataviz/jquery.sparkline.js"></script>
    
    <script type="text/javascript" src="js/utils.js"></script>
    
  </head>

<body>
  <div id="content">
    <button id="toggle_random">pause random</button>
    <div id="sphere"></div>
      <ul id="vars">
        <h1>inputs</h1>
        <div id="inputs">
        </div>
        
        <h1>results</h1>
        <div id="results">
          <li class="result" id="color"> <h2>color</h2>    
            <span class="viz"></span> <span class="value"></span> <span class="raw"></span> 
            <input type="text">
          </li>
          <li class="result" id="squared"><h2>squared</h2>
            <span class="viz"></span> <span class="value"></span> <span class="raw"></span>
            <input type="text">
          </li>
          <li class="result" id="output"><h2>output</h2>
            <span class="viz"></span> <span class="value"></span> <span class="raw"></span>
            <input type="text">
          </li>
        </div>
        <!-- <li>vx:<span id='vx'></span></li> -->
        <!-- <li>vy:<span id='vy'></span></li> -->
      </ul>
    </div>
  </div>
</body>

<script type="text/backbone-tmpl" id="input_template">
  <li id="<%= id %>"><h2><%= id %></h2> <span class="viz"></span> <span class="value"></span> <span class="raw"></span> </li>
</script>

<script type="text/javascript">




/*

 [√]  multiple values input in realtime
 [√]  multiple values calculated and output in realtime
 [√]  all values remember their history and display a sparkleline
 [√]  values normalised internally ( 0 - 1.0 )
 [√]  all changes bindable
 [√]  ids known so el: not needed
 
 [√]  calculate() updatable at runtime
 [√]  generate html 

----






 [ ]  vars.set({ 'foobar': 0.5 }) creates foobar, if it doesn't already exist


 [ ]  autonormalisation based on input extremes
 
 [ ]  bounding flag + working
 
 
 [ ]  proper separate library  -  snorkle.js
 
 [ ]  fix bug: same value()s mean no update to the variable



use cases

  faceosc
    animating faces with paper.js
    emoticon history
    logo manip
  
  touch
    logo manip
    

*/

function shorten (f) {
  if (typeof f == 'string') {
    return f
  }
  return Math.round(f * 10000) / 10000
}



var Model = {};

var options = { 
  normalRangeMin: 0, normalRangeMax: 1, 
  width: '120px', chartRangeClip: true, spotColor: false,
  minSpotColor: false, maxSpotColor: false
};



Model.Var = Backbone.Model.extend({
  initHistory: function() {
    this.bind( 'change:value', function() {
      var el = '#' + this.id;
      
      if (el) {
        $(el + " span.value").text( shorten( this.value() ) );
        $(el + " span.raw").text( shorten( this.get('raw') ) );
        $(el + " span.viz").sparkline( this.get('history'), options );
      }
    });
    
    this.set({ history_length: 50, history: [] });
  },
  addToHistory: function(v) {
    var h = this.get('history');
    
    if (h.length > this.get('history_length')) {
	    h.shift();
	  }
	  h.push( v );
	  
	  this.set({ history: h })
  }
});


Model.In = Model.Var.extend({
  initialize: function (options) {
    var initial = (typeof options.initial == "undefined" || options.initial == null) ? 0 : options.initial;
    
    this.initHistory();
    this.set({ raw: initial, value: initial });
    
    if (typeof options.range !== "undefined" && options.range !== null) {
      this.min = options.range.min;
      this.max = options.range.max;
    } else {
      this.min = 0;
      this.max = 1;
    }
  },
  value: function(v) {
    if (typeof v == "undefined" || v == null) {
      return this.get('value');
    }
    
    var raw = v;
  
    if (v < this.min) {
      this.min = v;
    }
    if (v > this.max) {
      this.max = v;
    }

    var diff = this.max - this.min;
    var off = 1 - this.max / diff;
  
    v = (v / diff) + off; // coax value to be 0.0 - 1.0
    
    this.addToHistory( v );

    this.set({ 
      value: v, 
      raw: raw 
    });
  }
});




Model.Out = Model.Var.extend({
  initialize: function(attr, calculate) {
    this.initHistory();
    this.setCalculate( calculate );
    return this;
  },
  setCalculate: function(f) {
    this.calculate = f;

    $('#' + this.id + " input").val( f + "" );
    
    return this;
  },
  calculateEntered: function(formula) {
    var f, ok = true;
    
    try {
      eval( "f = " + formula );
    } catch (e) {
      ok = false;
      // statements to handle any exceptions
      console.log('err' + e)
    }
    
    try {
      f.call( vars.reals );
    } catch (e) {
      console.log('err2 ' + e);
      ok = false;
    }

    ok && (this.calculate = f);
  },
  update: function() {
    if (typeof this.calculate == 'function') {
      var v = this.calculate.call( vars.reals );
      this.addToHistory( v );
      this.set({ value: v });
    } else {
      console.log('nah')
    }
  },
  value: function() {
    return this.get('value')
  }
  
});


$('input').keyup( function() {
  vars.get( $(this).parents('li').attr('id') ).calculateEntered( $(this).val() )
});


// .message('x')
// .listen('x y')


// 


var Vars = Backbone.Model.extend({
  initialize: function() {
    this.bind('change', function() {
      this.updateReals();
    });
    this.updateReals();
  },
  updateReals: function() {
    var that = this;
    this.reals = {};
        
    _.each(this.attributes, function(v, k) {
      that.reals[k] = v.get('value');
    });
  },
  recalculate: function() {
    _.each(this.attributes, function(v, k) {
      if (v.update) {
        v.update()
      }
    });
  },
  addInput: function(id, options) {
    options.id = id; // very useful
    
    
    $('ul#vars div#inputs').append( _.template( $('#input_template').html() )({ id: id }) );
    
    
    var v = new Model.In( options );
    this.set( kv(id, v) );
    return v;
  },
  addOutput: function(id, options) {
    options.id = id; // very useful
    
    var v = new Model.Out( options );
    this.set( kv(id, v) );
    return v;
  }
});







var vars = new Vars;
                         
vars.addInput( 'mouseX', { initial: 0.1 } );
vars.addInput( 'mouseY', { initial: 0.1 } );

var acc_options = { min: -10, max: 10,  initial: 0 };

vars.addInput( 'accX', acc_options );
vars.addInput( 'accY', acc_options );
vars.addInput( 'accZ', acc_options );

vars.addInput( 'random', { range: { min: 0, max: 1 }, initial: 0.5 } ),

vars.addOutput( 'squared', {} ).setCalculate( function() {
  return this.mouseX * this.mouseX
});

vars.addOutput( 'output', {} ).setCalculate( function() {
  return (this.accY + this.accX) / 2
});

vars.addOutput( 'color', {} ).setCalculate( function() {
  return "rgba(" + Math.floor(this.mouseX * 255) + ", "  + Math.floor(this.mouseY * 255) + ", 0, " + this.random + ")";
}).bind( 'change:value', function() {
  $('#color').css({ backgroundColor: vars.get('color').get('value') })
});




function tick () {
  _.delay(function() {
    
    vars.updateReals();
    vars.recalculate();
    
    tick();
  }, 50);
}

tick();






$(window).mousemove(function(e) {
  vars.get('mouseX').value( e.clientX );
  vars.get('mouseY').value( e.clientY );
});

// $('body').bind('touchstart', touched);
// $('body').bind('touchmove', touched);
  
  
function touched (e) {
  vars.get('mouseX').value( e.originalEvent.pageX );
  vars.get('mouseY').value( e.originalEvent.pageY );
  return false;
}



function set_random () {
  _.delay(function() {
    var now = vars.get('random').value();
    set_random.on && vars.get('random').value( now + (Math.random() > 0.5 ? 0.05 : -0.05) );
    set_random();
  }, 250);
}

set_random.on = false;
set_random();

$('#toggle_random').click( function() {
  set_random.on = (! set_random.on);
})




var acc = {
  x:  0, y:  0,
  vx: 0, vy: 0,
  ax: 0, ay: 0,
  e: 0
};

	
function p (id, num, len) {
  var pad = (num >= 0) ? ('+' + num) : '' + num,
      d = pad.substr(0, len || 4);
      
	document.getElementById( id ).innerHTML = d;
}

var sphere = document.getElementById("sphere");


if (window.DeviceMotionEvent != undefined) {
	window.ondevicemotion = function(ev) {
		acc.ax = event.accelerationIncludingGravity.x;
		acc.ay = event.accelerationIncludingGravity.y;
		acc.az = event.accelerationIncludingGravity.z;
		acc.e = ev;
	}
	
  var n = 0;
	setInterval( function() {
		var landscapeOrientation = window.innerWidth/window.innerHeight > 1;
		if ( landscapeOrientation) {
			acc.vx = acc.vx + acc.ay;
			acc.vy = acc.vy + acc.ax;
		} else {
			acc.vy = acc.vy - acc.ay;
			acc.vx = acc.vx + acc.ax;
		}
		acc.vx = acc.vx * 0.98;
		acc.vy = acc.vy * 0.98;
		acc.y = parseInt(acc.y + acc.vy / 50);
		acc.x = parseInt(acc.x + acc.vx / 50);
		
		
		vars.get('accX').value( acc.ax );
		vars.get('accY').value( acc.ay );		
    vars.get('accZ').value( acc.az );
		
		if (n++ % 10 == 0) {
//		  var tmp = e.accelerationIncludingGravity;
		  
          		  
/*		p("rotationAlpha", e.rotationRate.alpha);
  		p( "rotationBeta", e.rotationRate.beta);
  		p("rotationGamma", e.rotationRate.gamma); */
  		p("vx", acc.vx, 6);
  		p("vy", acc.vy, 6);
  		
		}
		boundingBoxCheck();
		
		sphere.style.top = acc.y + "px";
		sphere.style.left = acc.x + "px";
		
	}, 50);
} 


function boundingBoxCheck(){
	if (acc.x<0) { acc.x = 0; acc.vx = -acc.vx / 2; }
	if (acc.y<0) { acc.y = 0; acc.vy = -acc.vy / 2; }
	if (acc.x>document.documentElement.clientWidth-20) { acc.x = document.documentElement.clientWidth-20; acc.vx = -acc.vx / 2; }
	if (acc.y>document.documentElement.clientHeight-20) { acc.y = document.documentElement.clientHeight-20; acc.vy = -acc.vy / 2; }
	
  // if (vy < 5.5 && vy > -5.5) vy = 0;
  // if (vx < 5.5 && vx > 5.5 ) vx = 0;
}

</script>

</html>
